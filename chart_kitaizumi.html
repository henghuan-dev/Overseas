<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>波情報グラフ（iframe用）</title>
  <style>
  :root{
    --maxw:1700px; --pad:16px; --line:#e5e7eb;
    --accent:#0ea5e9; --ink:#333;

    /* ====== タイムライン見出しの“上に置く”ための余白 ====== */
    --timeline-header-space: 28px;   /* .chart-inner の上パディング */

    /* ====== マスク調整トークン（上下グラデ＋微ノイズ） ====== */
    --mask-top-opacity: .75;
    --mask-mid-opacity: .60;
    --mask-btm-opacity: .60;
    --mask-fade-left: 14px;     /* 左端ソフトフェード幅 */
    --mask-blur: 6px;           /* 上側の軽いブラー量（0で無効） */
    --mask-noise-alpha: .07;    /* 微細ノイズ透明度（0で無効） */
    --mask-noise-size: 1px;     /* 微細ノイズ間隔 */
  }

  *{box-sizing:border-box}
  html,body{margin:0;padding:0}
  body{
    background:#fff;color:var(--ink);
    font-family:"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;
    max-width:var(--maxw);width:100%;margin:0 auto;padding:0 var(--pad);
    overflow-x:hidden;
  }

  .chart-block{position:relative}
  .chart-scroll-container{
    overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;
    width:100%;padding-bottom:10px;position:relative;
  }

  /* ★ 見出し用に上方向の余白を確保（JS が読み取る） */
  .chart-inner{display:block;position:relative;padding-top:var(--timeline-header-space);}

  #overlayCanvas{position:absolute;top:0;left:0;pointer-events:auto;z-index:10}

  .forecast-block{background:linear-gradient(to bottom,#e5f6ff,#f0fbf9);padding:6px 0;position:relative}
  .block-title{font-size:13px;font-weight:bold;margin-bottom:4px;color:#333;position:sticky;left:0;z-index:10;width:140px;display:flex;align-items:center}
  .canvas-wrapper{overflow:hidden;position:relative} /* 波高マスクの親 */
  .forecast-block canvas{display:block;height:60px}

  .timeline-header{
    position:absolute;left:8px;max-width:calc(100% - 16px);
    white-space:nowrap;text-overflow:ellipsis;overflow:hidden;
    background:rgba(0,0,0,.3);color:#fff;backdrop-filter:blur(4px);
    border:1px solid rgba(255,255,255,.14);box-shadow:0 4px 12px rgba(0,0,0,.25);
    border-radius:999px;padding:3px 10px;font-size:12px;line-height:1.6;pointer-events:none;
    /* JS が top を再配置します。ここは初期値（保険） */
    top:4px;
  }

  .time-axis{display:flex;overflow-x:auto;border-radius:6px;margin:12px 0;border:1px solid rgba(0,0,0,.05);scrollbar-width:none;-ms-overflow-style:none}
  .time-axis::-webkit-scrollbar{display:none}
  .time-labels{display:flex;min-width:max-content}
  .time-labels>div{flex:0 0 50px;width:50px;text-align:center;font-size:10px}
  .time-labels .current{background:rgba(0,191,255,.2);font-weight:bold;box-shadow:inset 0 -2px 0 #00bfff}
  #timeLabels.time-labels>div>div{line-height:12px;font-size:11px}
  :root{--timeline-pill-bg:#e0e0e0;--timeline-pill-fg:#222}
  #timeLabels .date-pill.is-visible{padding:0 4px;border-radius:4px;background:var(--timeline-pill-bg);color:var(--timeline-pill-fg);font-weight:700}
  #timeLabels .hour-label.is-zero-hour{padding:0 4px;border-radius:4px;background:var(--timeline-pill-bg);color:var(--timeline-pill-fg);font-weight:700}

  .overlay-highlight{background-color:rgba(0,191,255,.15)}
  .overlay-line{border-left:2px solid rgba(0,191,255,.9)}

  #tooltip{
    position:absolute;background:rgba(0,0,0,.85);color:#fff;padding:8px 10px;border-radius:4px;
    font-size:13px;line-height:1.4;pointer-events:none;z-index:20;display:none;
    box-shadow:0 4px 12px rgba(0,0,0,.3);max-width:180px;transform: translateY(-20px);
    will-change: left, top, transform;
  }

  .wave-tide .block-title{color:#2a7d9eff;border-left:4px solid #2a7d9eff;padding-left:6px}
  #waveValueCanvas{height:28px}
  #waveTideCanvas{height:150px}

  .tide-only .block-title{color:#2a7d9e;border-left:4px solid #2a7d9e;padding-left:6px}
  #tideLineCanvas{height:120px}

  .wind-combo .block-title{color:#2a7d9eff;border-left:4px solid #2a7d9eff;padding-left:6px}

  /* ===== 波高だけ：3日目以降 “上：不透明 / 下：半透明” マスク ===== */
  .wave-mask{
    position:absolute;
    /* 横幅と left/top/height は JS が設定します */
    width:0%; display:none; z-index:300;
    pointer-events:auto;                      /* 背後のホバーは遮断 */
    border-left:1px dashed var(--line);

    /* 縦グラデ＋微細ノイズ（見せ方の本体） */
    background-image:
      linear-gradient(to bottom,
        rgba(255,255,255,var(--mask-top-opacity))  5%,
        rgba(255,255,255,var(--mask-mid-opacity)) 60%,
        rgba(255,255,255,var(--mask-btm-opacity)) 100%
      ),
      radial-gradient(circle at 1px 1px,
        rgba(0,0,0,var(--mask-noise-alpha)) 1px,
        rgba(0,0,0,0) 1px);
    background-size: auto, var(--mask-noise-size) var(--mask-noise-size);
    background-repeat: no-repeat, repeat;

    /* 左端をソフトに馴染ませる（横方向） */
    -webkit-mask-image: linear-gradient(90deg, transparent 0, #000 var(--mask-fade-left), #000 100%);
            mask-image: linear-gradient(90deg, transparent 0, #000 var(--mask-fade-left), #000 100%);

    /* 本体にはフィルタを掛けない（下部の見え方を確保） */
    -webkit-backdrop-filter: none;
            backdrop-filter: none;

    will-change: left, width, top, height;
  }

  /* 上側だけにごく弱いブラーと白ベールを重ねる（下部はクリア） */
  .wave-mask::after{
    content:"";
    position:absolute;
    inset:0 0 var(--mask-clear-bottom, 18%) 0; /* 下から何%を“フィルタ無し”にするか */
    pointer-events:none;

    background: linear-gradient(to bottom,
                rgba(255,255,255, var(--mask-top-opacity)) 0%,
                rgba(255,255,255, .35) 60%,
                rgba(255,255,255, 0) 100%);

    -webkit-backdrop-filter: blur(var(--mask-blur)) contrast(.95) saturate(.95) brightness(.98);
            backdrop-filter: blur(var(--mask-blur)) contrast(.95) saturate(.95) brightness(.98);

    -webkit-mask-image: linear-gradient(90deg, transparent 0, #000 var(--mask-fade-left), #000 100%);
            mask-image: linear-gradient(90deg, transparent 0, #000 var(--mask-fade-left), #000 100%);
  }

  /* mask-image 非対応フォールバック（左端のみ） */
  @supports not ((-webkit-mask-image: linear-gradient(#000,#000)) or (mask-image: linear-gradient(#000,#000))){
    .wave-mask::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,.85) var(--mask-fade-left), rgba(255,255,255,0) 0);
      pointer-events:none;
    }
  }

  /* 画面固定の案内カード（最前面へ） */
  .lock__card--fixed{
    position:fixed;
    z-index:850;              /* ← 310 から引き上げ */
    display:none;
    max-width:min(560px, 92vw);
    background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px 16px;
    box-shadow:0 10px 30px rgba(0,0,0,.12);
    pointer-events:auto;
  }
  .lock__card--fixed .title{font-size:15px;font-weight:800;margin:0 0 6px}
  .lock__card--fixed .desc{font-size:13px;color:#444;margin:0 0 10px;line-height:1.6}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;font-size:13px;font-weight:700;border-radius:999px;text-decoration:none;border:1px solid var(--accent);background:var(--accent);color:#fff}

  /* 画面外クランプ時の方向フラグ（任意） */
  .lock__card--fixed[data-offscreen="left"]::before,
  .lock__card--fixed[data-offscreen="right"]::before{
    content:"";
    position:absolute; top:8px;
    width:10px; height:10px;
    border-top:2px solid currentColor;
    border-left:2px solid currentColor;
    opacity:.6;
  }
  .lock__card--fixed[data-offscreen="left"]::before{
    left:-6px; transform:rotate(-45deg);
  }
  .lock__card--fixed[data-offscreen="right"]::before{
    right:-6px; transform:rotate(135deg);
  }

  @media (max-width:768px){
    .forecast-block{padding:6px 8px;margin-bottom:10px}
    .block-title{margin-bottom:4px;font-size:13px;width:120px;position:sticky;left:0;z-index:10;padding:4px 0}
    #tideLineCanvas{height:160px!important}
  }
</style>


</head>
<body>
  <div class="chart-block">
    <div class="chart-scroll-container" id="scrollX">
      <div class="chart-inner" id="chartInner">
        <div class="time-axis">
          <div id="timeLabels" class="time-labels"></div>
        </div>

        <!-- 波高 -->
        <section class="forecast-block wave-tide" id="waveBlock">
          <h3 class="block-title">波高 (m)</h3>
          <div class="canvas-wrapper" id="waveWrapper">
            <canvas id="waveValueCanvas"></canvas>
            <canvas id="waveTideCanvas"></canvas>
            <!-- ★ 3日目以降の“右側”を覆い、内部は「上=不透明 / 下=半透明」 -->
            <div class="wave-mask" id="waveMask"></div>
          </div>
        </section>

        <!-- 風 -->
        <section class="forecast-block wind-combo">
          <h3 class="block-title">風速 (m/s) &amp; 風向</h3>
          <div class="canvas-wrapper"><canvas id="windCanvas"></canvas></div>
        </section>

        <!-- 潮汐 -->
        <section class="forecast-block tide-only">
          <h3 class="block-title">潮汐 (m)</h3>
          <div class="canvas-wrapper"><canvas id="tideLineCanvas"></canvas></div>
        </section>

        <!-- オーバーレイ（ガイド／日付バッジ） -->
        <canvas id="overlayCanvas"></canvas>
      </div>
    </div>
    <div id="tooltip"></div>
  </div>

  <!-- 画面固定の案内カード（波高上に被せ／ボタンあり） -->
  <div class="lock__card--fixed" id="lockCardFixed" aria-live="polite">
    <p class="title">この先のデータは有料会員限定です</p>
    <p class="desc">無料プランでは直近<strong>2日間</strong>の波高グラフのみ表示されます。</p>
    <div><a class="btn" href="https://liff.namiaru.com/mypage.html">マイページへ</a></div>
  </div>

  <script type="module">
    import { loadSurfData } from './js/dataLoader_kitaizumi.js';
    import { setData, drawAllCharts } from './js/draw_kitaizumi.js?v=0.3';

    const params = new URLSearchParams(location.search);
    const pay    = Number.isFinite(Number(params.get('paystatus'))) ? Number(params.get('paystatus')) : 1;
    const spotId = params.get('spotId') || params.get('spotid') || '';
    const csvArg = params.get('csv');
    const isPaid = pay >= 4;

    const HOURS_MASK_START = 48;      // 3日目開始（2日＝48h）
    const HOURS_FULL       = 17 * 24; // 408h（描画はフル）

    window.PAY_MODE = isPaid ? 'paid' : 'free';
    window.CHART_RANGE_HOURS = HOURS_FULL; // 描画はフル、UIで波高のみマスク

    async function resolveCsvPath(){
      if (csvArg) return decodeURIComponent(csvArg);
      if (!spotId) return './data/640a772f606c45654dbda6fd.csv';
      try{
        const res  = await fetch('./data/points.json', { cache:'no-store' });
        const list = await res.json();
        const hit  = list.find(x => String(x.spotid) === String(spotId));
        if (!hit) return `./renew/data/${spotId}.csv`;
        return hit.dataCsv || hit.csv || `./renew/data/${spotId}.csv`;
      }catch{ return `./renew/data/${spotId}.csv`; }
    }

    // 3日目以降の“右側”を波高レイヤにだけマスク + 固定カードをマスク開始位置に配置
    function applyWaveMask(){
      const mask = document.getElementById('waveMask');
      const card = document.getElementById('lockCardFixed');
      if (!mask || !card) return;
      if (isPaid){
        mask.style.display = 'none';
        card.style.display = 'none';
      }else{
        // 位置は draw_kitaizumi.js 側 measureAndSize() で決まる
        mask.style.display = 'block';
        card.style.display = 'block';
      }
    }

    function clamp(v, min, max){ return Math.max(min, Math.min(v, max)); }


    function syncOverlaySize(){
      const overlay = document.getElementById('overlayCanvas');
      const inner   = document.getElementById('chartInner');
      if (!overlay || !inner) return;
      const rect = inner.getBoundingClientRect();
      overlay.width = Math.ceil(rect.width);
      overlay.height = Math.ceil(inner.scrollHeight);
      overlay.style.width = rect.width + 'px';
      overlay.style.height = inner.scrollHeight + 'px';
    }

    async function initChart(){
      const csvPath = await resolveCsvPath();
      try{
        const data = await loadSurfData(csvPath, { fetchOptions:{ cache:'no-store' }});
        setData(data);
        drawAllCharts();
        syncOverlaySize();
        applyWaveMask();

        // リサイズでのみ再配置（横スクロールでは固定）
        window.addEventListener('resize', () => {
          syncOverlaySize();
          applyWaveMask();
        });
      }catch(e){ console.error('CSV読み込み失敗:', csvPath, e); }
    }

    initChart();
  </script>
</body>
</html>
